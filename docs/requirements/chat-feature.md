# チャット機能 - 要件定義書

## 1. プロジェクト概要

### 基本情報
- **プロジェクト名**: 会社備品管理システム - チャット機能追加
- **目的**: ユーザーと管理者間のコミュニケーションを円滑化し、備品に関する問い合わせやサポート依頼をリアルタイムで行えるようにする
- **背景**:
  - 備品の使い方や状態について質問したいが、連絡手段がない
  - トラブル発生時に管理者へ迅速に連絡したい
  - メールや口頭での連絡では履歴が残らず、対応漏れが発生する
- **スコープ**:
  - 対象範囲: ユーザーと管理者間の1対1チャット機能
  - 対象外: ユーザー同士のチャット、グループチャット
- **成果物**: WebSocketを使用したリアルタイムチャット機能
- **ステークホルダー**:
  - 一般ユーザー（備品利用者）
  - 管理者（サポート担当者）

### 現状と課題

**As-Is（現状）**
- 備品に関する問い合わせはメールや口頭で行われている
- 問い合わせ履歴が残らず、対応状況が不明確
- レスポンスが遅く、緊急時の対応が困難
- 管理者側で問い合わせの優先順位付けができない

**課題**
- コミュニケーション手段が統一されていない
- 問い合わせ内容と備品の紐付けが曖昧
- 対応状況の可視化ができない
- 画像などで状態を共有する手段がない

**To-Be（理想）**
- システム内で完結するリアルタイムチャット
- 備品との関連性が明確
- 履歴が30日間保存され、過去の対応を参照可能
- 画像添付で状態を正確に伝達
- 未読メッセージの通知

**期待効果**
- 問い合わせ対応時間の短縮（50%削減目標）
- 対応漏れの防止（履歴管理）
- ユーザー満足度の向上
- 管理者の業務効率化

---

## 2. 機能要件

### 機能一覧

| ID | 機能名 | 優先度 | 概要 | 関連ユーザー |
|----|--------|--------|------|--------------|
| F001 | チャット一覧表示 | Must | 自分が参加しているチャットルーム一覧を表示 | 全ユーザー |
| F002 | チャットルーム作成 | Must | 新しいチャットルームを作成（ユーザー→管理者） | 一般ユーザー |
| F003 | メッセージ送信 | Must | テキストメッセージをリアルタイムで送信 | 全ユーザー |
| F004 | メッセージ受信 | Must | WebSocketでリアルタイムにメッセージを受信 | 全ユーザー |
| F005 | 画像添付 | Must | 画像ファイルをメッセージに添付して送信 | 全ユーザー |
| F006 | 未読管理 | Must | 未読メッセージ数の表示と既読化 | 全ユーザー |
| F007 | チャットUI（サイドパネル） | Must | 画面右側からスライド表示されるチャットパネル | 全ユーザー |
| F008 | 備品からのチャット開始 | Must | 備品詳細ページから該当備品についてチャット開始 | 一般ユーザー |
| F009 | ヘッダーからチャット開始 | Must | ヘッダーのチャットアイコンから一般的な問い合わせ | 一般ユーザー |
| F010 | チャット履歴表示 | Must | 過去30日間のメッセージ履歴を表示 | 全ユーザー |
| F011 | 管理者のチャット一覧 | Must | 全ユーザーからのチャットを一覧管理 | 管理者 |
| F012 | 新着通知 | Should | 新しいメッセージが届いたら通知表示 | 全ユーザー |

---

### 機能詳細

#### F001: チャット一覧表示

**概要**
ユーザーが参加している全てのチャットルームを一覧表示する機能

**ユーザーストーリー**
```
As a ユーザー
I want to 自分のチャット履歴を一覧で確認したい
So that 過去の問い合わせを簡単に見つけられる
```

**ユースケース**
- **アクター**: 全ユーザー
- **トリガー**: ヘッダーのチャットアイコンをクリック、またはチャットサイドパネルを開く
- **事前条件**: ユーザーがログインしている
- **正常フロー**:
  1. ユーザーがチャットアイコンをクリック
  2. システムがサイドパネルを右側からスライド表示
  3. システムが該当ユーザーの全チャットルームを取得
  4. チャットルーム一覧を表示（最新メッセージ順）
  5. 各ルームに未読件数、最終メッセージ、相手名、タイムスタンプを表示
- **代替フロー**: なし
- **例外フロー**:
  - 3-1. チャットルームが0件 → 「まだチャットがありません」メッセージ表示
  - 3-2. 取得エラー → エラーメッセージ表示
- **事後条件**: チャットルーム一覧が表示される

**画面要件**

*チャット一覧（サイドパネル）*
```
┌─────────────────────────────┐
│ [×] チャット                │
├─────────────────────────────┤
│ [新規チャット]              │
├─────────────────────────────┤
│ 🟢 管理者（田中）            │ (2)
│ 📦 ノートPC - 動作不良      │
│ 承知しました。確認します     │
│ 2分前                       │
├─────────────────────────────┤
│ ⚪ 管理者（田中）            │
│ 💬 一般的な問い合わせ        │
│ ありがとうございました       │
│ 1時間前                     │
├─────────────────────────────┤
│ ⚪ 管理者（田中）            │
│ 📦 プロジェクター - 予約    │
│ かしこまりました             │
│ 1日前                       │
└─────────────────────────────┘
```

**データ要件**

*出力データ*
```typescript
type ChatRoomListItem = {
  id: string;                    // チャットルームID（UUID）
  title: string;                 // チャットルームタイトル
  lastMessage: string;           // 最後のメッセージ内容（50文字まで）
  lastMessageAt: string;         // 最終メッセージ日時（ISO 8601）
  unreadCount: number;           // 未読件数
  otherUser: {                   // 相手ユーザー
    id: string;
    name: string;
    role: 'user' | 'admin';
  };
  equipmentId?: string;          // 関連備品ID（任意）
};
```

**ビジネスルール**
- BR001: チャットルーム一覧は最終メッセージ日時の降順で表示
- BR002: 未読件数が0の場合は表示しない
- BR003: 最終メッセージが30日以上前のルームは非表示（アーカイブ扱い）
- BR004: 管理者は全ユーザーのチャットルームを閲覧可能

**受入基準**
```gherkin
Feature: チャット一覧表示

Scenario: ユーザーがチャット一覧を開く
  Given 一般ユーザーとしてログインしている
  And 3件のチャットルームが存在する
  When ヘッダーのチャットアイコンをクリックする
  Then サイドパネルが右側からスライド表示される
  And 3件のチャットルームが最新順に表示される
  And 各ルームに最終メッセージと時刻が表示される

Scenario: 未読メッセージがある場合
  Given 一般ユーザーとしてログインしている
  And チャットルームに未読メッセージが2件ある
  When チャット一覧を開く
  Then 未読件数「(2)」がバッジで表示される
  And ルームが太字で強調表示される

Scenario: チャットルームが存在しない場合
  Given 一般ユーザーとしてログインしている
  And チャットルームが0件
  When チャット一覧を開く
  Then 「まだチャットがありません」メッセージが表示される
  And 「新規チャット」ボタンが表示される
```

---

#### F002: チャットルーム作成

**概要**
ユーザーが管理者に対して新しいチャットルームを作成する機能

**ユーザーストーリー**
```
As a 一般ユーザー
I want to 管理者に問い合わせを開始したい
So that 備品やシステムについてサポートを受けられる
```

**ユースケース**
- **アクター**: 一般ユーザー
- **トリガー**:
  - 備品詳細ページの「問い合わせ」ボタンをクリック
  - ヘッダーのチャットアイコンから「新規チャット」をクリック
- **事前条件**: ユーザーがログインしている
- **正常フロー**:
  1. ユーザーが「問い合わせ」または「新規チャット」をクリック
  2. システムが以下を確認:
     - 備品詳細から: 該当備品に関する既存チャットがあるか
     - 新規チャット: 一般的な問い合わせの既存チャットがあるか
  3. 既存チャットがない場合、新規チャットルームを作成
  4. チャットルームのタイトルを設定:
     - 備品から: 「備品名 - 問い合わせ」
     - 新規: 「一般的な問い合わせ」
  5. 管理者（デフォルト管理者ユーザー）を参加者に追加
  6. チャット画面を開く
- **代替フロー**:
  - 3-1. 既存チャットがある → 既存チャットを開く
- **例外フロー**:
  - 3-1. 作成エラー → エラーメッセージ表示
- **事後条件**:
  - 新しいチャットルームが作成される
  - チャット画面が表示される

**画面要件**

*備品詳細ページ - 問い合わせボタン*
```
┌─────────────────────────────────┐
│ ノートパソコン                  │
│ カテゴリ: 電子機器              │
│ 在庫: 5台                       │
│                                 │
│ [貸出する] [問い合わせ 💬]     │
└─────────────────────────────────┘
```

*チャット一覧 - 新規チャットボタン*
```
┌─────────────────────────────┐
│ [×] チャット                │
├─────────────────────────────┤
│ [+ 新規チャット]            │
├─────────────────────────────┤
│ （チャットルーム一覧）      │
└─────────────────────────────┘
```

**データ要件**

*入力データ*
```typescript
type CreateChatRoomRequest = {
  equipmentId?: string;          // 備品ID（備品から開始した場合）
  initialMessage?: string;       // 初回メッセージ（任意）
};
```

*保存データ（chat-rooms.json）*
```json
{
  "id": "uuid",
  "title": "ノートパソコン - 問い合わせ",
  "participants": ["user-uuid", "admin-uuid"],
  "equipmentId": "equipment-uuid",
  "createdAt": "2024-01-15T10:30:00Z",
  "updatedAt": "2024-01-15T10:30:00Z"
}
```

**ビジネスルール**
- BR001: 一般ユーザーはチャットルームを作成できる
- BR002: 同じ備品に関する未解決チャットがある場合、新規作成せず既存を使う
- BR003: 管理者は自動的に参加者に追加される
- BR004: チャットルームのタイトルは自動生成（ユーザーは編集不可）
- BR005: 管理者は直接チャットルームを作成しない（ユーザーからの依頼を待つ）

**バリデーション**
- equipmentId は UUID形式（指定時）
- equipmentId が指定された場合、該当備品が存在すること
- ユーザーがログイン済みであること

**受入基準**
```gherkin
Feature: チャットルーム作成

Scenario: 備品詳細ページから問い合わせを開始
  Given 一般ユーザーとしてログインしている
  And 備品「ノートPC」の詳細ページを表示中
  When 「問い合わせ」ボタンをクリックする
  Then 新しいチャットルームが作成される
  And チャットタイトルが「ノートPC - 問い合わせ」になる
  And 管理者が自動的に参加者に追加される
  And チャット画面が開く

Scenario: 既存の備品チャットがある場合
  Given 一般ユーザーとしてログインしている
  And 備品「ノートPC」に関する既存チャットがある
  When 備品詳細ページで「問い合わせ」をクリックする
  Then 新規チャットは作成されない
  And 既存のチャットルームが開く

Scenario: 一般的な問い合わせを開始
  Given 一般ユーザーとしてログインしている
  When ヘッダーのチャットアイコンから「新規チャット」をクリックする
  Then 新しいチャットルームが作成される
  And チャットタイトルが「一般的な問い合わせ」になる
  And チャット画面が開く
```

---

#### F003 & F004: メッセージ送受信（リアルタイム）

**概要**
WebSocketを使用してリアルタイムでメッセージを送受信する機能

**ユーザーストーリー**
```
As a ユーザー
I want to メッセージをリアルタイムで送受信したい
So that スムーズなコミュニケーションができる
```

**ユースケース**
- **アクター**: 全ユーザー
- **トリガー**: メッセージ入力欄でEnterキーまたは送信ボタンをクリック
- **事前条件**:
  - チャットルームが開かれている
  - WebSocket接続が確立されている
- **正常フロー**:
  1. ユーザーがメッセージを入力し、Enterキーまたは送信ボタンをクリック
  2. システムがメッセージをバリデーション（空文字チェック、文字数制限）
  3. メッセージをサーバーに送信（WebSocket経由）
  4. サーバーがメッセージを保存（messages.json）
  5. サーバーが該当チャットルームの全参加者にメッセージをブロードキャスト
  6. クライアントがメッセージを受信し、チャット画面に表示
  7. 送信者側は既読状態、受信者側は未読状態
- **代替フロー**: なし
- **例外フロー**:
  - 2-1. メッセージが空 → エラーメッセージ表示、送信しない
  - 2-2. 文字数超過（1000文字） → エラーメッセージ表示
  - 3-1. WebSocket切断中 → 「接続が切れています」エラー表示
  - 4-1. 保存エラー → エラーメッセージ表示、再送信ボタン表示
- **事後条件**:
  - メッセージが保存される
  - 全参加者の画面にメッセージが表示される
  - 未読カウントが更新される

**画面要件**

*チャット画面（メッセージエリア）*
```
┌─────────────────────────────────┐
│ [←] ノートPC - 問い合わせ      │
├─────────────────────────────────┤
│                                 │
│ 👤 山田太郎（あなた） 10:30     │
│ ┌───────────────────────┐       │
│ │ ノートPCが起動しません   │       │
│ └───────────────────────┘       │
│                                 │
│         👤 管理者 10:31         │
│       ┌───────────────────┐     │
│       │ 確認いたします     │     │
│       └───────────────────┘     │
│                                 │
│ 👤 山田太郎（あなた） 10:32     │
│ ┌───────────────────────┐       │
│ │ よろしくお願いします   │       │
│ └───────────────────────┘       │
│                                 │
├─────────────────────────────────┤
│ [📎] メッセージを入力...        │
│                        [送信]   │
└─────────────────────────────────┘
```

**データ要件**

*入力データ*
```typescript
type SendMessageRequest = {
  chatRoomId: string;            // チャットルームID
  content: string;               // メッセージ内容（1-1000文字）
  attachmentUrl?: string;        // 添付画像URL（任意）
};
```

*保存データ（messages.json）*
```json
{
  "id": "uuid",
  "chatRoomId": "chat-room-uuid",
  "senderId": "user-uuid",
  "content": "ノートPCが起動しません",
  "attachmentUrl": null,
  "createdAt": "2024-01-15T10:30:00Z",
  "readBy": ["sender-uuid"]
}
```

*WebSocketイベント*
```typescript
// クライアント → サーバー
type WSSendMessage = {
  type: 'message:send';
  payload: SendMessageRequest;
};

// サーバー → クライアント
type WSNewMessage = {
  type: 'message:new';
  payload: Message;
};

type WSMessageRead = {
  type: 'message:read';
  payload: {
    messageId: string;
    readBy: string;
  };
};
```

**ビジネスルール**
- BR001: メッセージの最大文字数は1000文字
- BR002: メッセージは送信順に表示（createdAt昇順）
- BR003: 自分のメッセージは右寄せ、相手のメッセージは左寄せ
- BR004: 送信者は自動的に既読状態（readBy配列に追加）
- BR005: メッセージ削除機能は提供しない（編集不可）

**非機能要件（リアルタイム性）**
- WebSocket接続を使用
- メッセージ配信遅延: 500ms以内
- 接続切断時の自動再接続（最大3回リトライ）
- オフライン時の送信キュー機能（最大10件まで保持）

**バリデーション**
- content は必須、1-1000文字
- chatRoomId は UUID形式
- 送信者がチャットルームの参加者であること
- WebSocket接続が有効であること

**受入基準**
```gherkin
Feature: メッセージ送受信

Scenario: メッセージを送信する
  Given 一般ユーザーとしてログインしている
  And チャットルーム「ノートPC - 問い合わせ」を開いている
  When メッセージ「起動しません」を入力して送信する
  Then メッセージが自分の画面に即座に表示される
  And メッセージが右寄せで表示される
  And メッセージが送信済み状態（既読）になる

Scenario: メッセージを受信する
  Given 管理者としてログインしている
  And チャットルームを開いている
  When ユーザーがメッセージ「起動しません」を送信する
  Then 500ms以内に自分の画面にメッセージが表示される
  And メッセージが左寄せで表示される
  And 未読状態として表示される
  And 未読カウントが+1される

Scenario: 空のメッセージは送信できない
  Given チャットルームを開いている
  When メッセージを入力せずに送信ボタンをクリックする
  Then エラーメッセージ「メッセージを入力してください」が表示される
  And メッセージは送信されない

Scenario: 接続切断時の処理
  Given チャットルームを開いている
  And WebSocket接続が切断された
  When メッセージを送信しようとする
  Then エラーメッセージ「接続が切れています」が表示される
  And 自動再接続が試行される
```

---

#### F005: 画像添付

**概要**
メッセージに画像ファイルを添付して送信する機能

**ユーザーストーリー**
```
As a ユーザー
I want to 画像を添付してメッセージを送りたい
So that 備品の状態や問題を視覚的に伝えられる
```

**ユースケース**
- **アクター**: 全ユーザー
- **トリガー**: メッセージ入力欄の添付ボタン（📎）をクリック
- **事前条件**: チャットルームが開かれている
- **正常フロー**:
  1. ユーザーが添付ボタンをクリック
  2. ファイル選択ダイアログが開く
  3. ユーザーが画像ファイルを選択
  4. システムが画像をバリデーション（形式、サイズ）
  5. 画像をプレビュー表示
  6. ユーザーがメッセージを入力（任意）し、送信
  7. 画像をサーバーにアップロード（`/uploads/chat/` ディレクトリ）
  8. アップロード完了後、メッセージとして送信
  9. 受信側では画像をサムネイル表示、クリックで拡大
- **代替フロー**:
  - 3-1. ユーザーがキャンセル → ファイル選択をキャンセル
  - 6-1. メッセージ未入力 → 画像のみで送信可能
- **例外フロー**:
  - 4-1. ファイル形式が非対応（PNG, JPG, GIF以外） → エラーメッセージ
  - 4-2. ファイルサイズ超過（5MB超） → エラーメッセージ
  - 7-1. アップロード失敗 → エラーメッセージ、再試行ボタン
- **事後条件**:
  - 画像がサーバーに保存される
  - メッセージに画像URLが含まれる

**画面要件**

*画像添付フロー*
```
┌─────────────────────────────────┐
│ [📎] メッセージを入力...        │
│                        [送信]   │
└─────────────────────────────────┘
        ↓ クリック
┌─────────────────────────────────┐
│ ファイルを選択                  │
│ - photo.jpg                     │
│ - screenshot.png                │
└─────────────────────────────────┘
        ↓ 選択
┌─────────────────────────────────┐
│ [プレビュー]                    │
│ ┌─────────────────────┐         │
│ │                     │         │
│ │   [画像サムネイル]  │ [×]    │
│ │                     │         │
│ └─────────────────────┘         │
│ メッセージを入力（任意）...     │
│                        [送信]   │
└─────────────────────────────────┘
```

*送信後の表示*
```
┌─────────────────────────────────┐
│ 👤 山田太郎（あなた） 10:30     │
│ ┌───────────────────────┐       │
│ │ [画像サムネイル 200x150]│       │
│ │ 起動時にこの画面になります│       │
│ └───────────────────────┘       │
└─────────────────────────────────┘
```

**データ要件**

*アップロード時*
```typescript
type UploadImageRequest = {
  file: File;                    // 画像ファイル
  chatRoomId: string;            // チャットルームID
};

type UploadImageResponse = {
  success: boolean;
  url: string;                   // アップロード後のURL
  thumbnailUrl: string;          // サムネイルURL
};
```

*保存場所*
- フルサイズ: `/public/uploads/chat/{chatRoomId}/{uuid}.{ext}`
- サムネイル: `/public/uploads/chat/{chatRoomId}/thumb_{uuid}.{ext}`

**ビジネスルール**
- BR001: 対応形式: PNG, JPG, JPEG, GIF
- BR002: 最大ファイルサイズ: 5MB
- BR003: サムネイルサイズ: 300x300px（アスペクト比維持）
- BR004: 画像は30日後に自動削除（メッセージと連動）
- BR005: 1メッセージにつき1画像まで

**バリデーション**
- ファイル形式が PNG, JPG, JPEG, GIF のいずれか
- ファイルサイズが 5MB 以下
- ユーザーがチャットルームの参加者であること

**受入基準**
```gherkin
Feature: 画像添付

Scenario: 画像を添付してメッセージを送信
  Given チャットルームを開いている
  When 添付ボタンをクリックする
  And PNG画像（2MB）を選択する
  Then プレビューが表示される
  When メッセージ「この状態です」を入力して送信する
  Then 画像がアップロードされる
  And メッセージと画像が表示される

Scenario: サイズ超過でエラー
  Given チャットルームを開いている
  When 添付ボタンをクリックする
  And 10MBの画像を選択する
  Then エラーメッセージ「ファイルサイズは5MB以下にしてください」が表示される
  And アップロードされない

Scenario: 非対応形式でエラー
  Given チャットルームを開いている
  When 添付ボタンをクリックする
  And PDFファイルを選択する
  Then エラーメッセージ「PNG, JPG, GIF形式のみ対応しています」が表示される

Scenario: 画像クリックで拡大表示
  Given チャット画面に画像付きメッセージが表示されている
  When 画像サムネイルをクリックする
  Then フルサイズ画像がモーダルで表示される
  And [×]ボタンで閉じることができる
```

---

#### F006: 未読管理

**概要**
メッセージの既読・未読を管理し、未読件数を表示する機能

**ユーザーストーリー**
```
As a ユーザー
I want to 未読メッセージの数を確認したい
So that 対応が必要なチャットを優先的に確認できる
```

**ユースケース**
- **アクター**: 全ユーザー
- **トリガー**:
  - 新しいメッセージを受信
  - チャットルームを開く
  - メッセージが画面に表示される
- **事前条件**: ユーザーがログインしている
- **正常フロー**:
  1. 新しいメッセージが届く
  2. システムが該当チャットルームの未読件数を+1
  3. チャット一覧に未読バッジを表示
  4. ヘッダーのチャットアイコンに総未読件数バッジを表示
  5. ユーザーがチャットルームを開く
  6. 画面に表示された全メッセージを既読化（readBy配列に追加）
  7. サーバーに既読通知を送信（WebSocket）
  8. 未読件数をリアルタイムで更新
- **代替フロー**: なし
- **例外フロー**:
  - 7-1. 既読通知の送信失敗 → バックグラウンドでリトライ
- **事後条件**:
  - メッセージが既読状態になる
  - 未読カウントが更新される

**画面要件**

*ヘッダーの未読バッジ*
```
┌─────────────────────────────────┐
│ [ロゴ] [備品] [貸出] [💬(5)]   │
└─────────────────────────────────┘
```

*チャット一覧の未読バッジ*
```
┌─────────────────────────────┐
│ 🟢 管理者（田中）       (2) │
│ 📦 ノートPC - 動作不良      │
│ 承知しました。確認します     │
└─────────────────────────────┘
```

**データ要件**

*Message型の readBy フィールド*
```typescript
type Message = {
  id: string;
  chatRoomId: string;
  senderId: string;
  content: string;
  attachmentUrl?: string;
  readBy: string[];              // 既読したユーザーIDの配列
  createdAt: string;
};
```

*既読通知（WebSocket）*
```typescript
type WSMarkAsRead = {
  type: 'message:mark_as_read';
  payload: {
    chatRoomId: string;
    userId: string;
  };
};
```

**ビジネスルール**
- BR001: 送信者は自動的に既読状態
- BR002: チャットルームを開いた時点で全未読メッセージを既読化
- BR003: 未読件数はリアルタイムで更新
- BR004: 30日経過したメッセージは未読カウントから除外（自動削除対象）

**受入基準**
```gherkin
Feature: 未読管理

Scenario: 新しいメッセージで未読カウントが増える
  Given 一般ユーザーとしてログインしている
  And チャット一覧を表示中
  When 管理者から新しいメッセージが届く
  Then チャットルーム一覧の該当ルームに未読バッジ「(1)」が表示される
  And ヘッダーのチャットアイコンに未読バッジが表示される

Scenario: チャットルームを開くと既読になる
  Given 一般ユーザーとしてログインしている
  And 未読メッセージが2件ある
  When 該当のチャットルームを開く
  Then すべてのメッセージが既読状態になる
  And 未読バッジが消える
  And ヘッダーの総未読カウントが-2される

Scenario: 複数チャットの未読管理
  Given 一般ユーザーとしてログインしている
  And チャットA に未読3件、チャットB に未読2件
  When ヘッダーのチャットアイコンを確認する
  Then 未読バッジに「(5)」と表示される
  When チャットAを開く
  Then チャットAの未読バッジが消える
  And ヘッダーの未読バッジが「(2)」に更新される
```

---

## 3. 非機能要件

### パフォーマンス要件

| 項目 | 目標値 | 測定条件 |
|------|--------|----------|
| メッセージ送信応答時間 | 500ms以内 | 平均値、通常時 |
| メッセージ受信遅延 | 500ms以内 | WebSocket経由 |
| 画像アップロード時間 | 3秒以内 | 2MB画像、通常ネットワーク |
| チャット一覧読込時間 | 1秒以内 | 50件のチャットルーム |
| 同時接続数 | 50ユーザー | WebSocket接続、パフォーマンス劣化なし |
| メッセージ表示件数 | 初回50件 | スクロールで追加読込（無限スクロール） |

### セキュリティ要件

| ID | 要件 | 対策 |
|----|------|------|
| S001 | 認証必須 | 全チャット機能にログイン必須 |
| S002 | 権限制御 | ユーザーは自分が参加するチャットのみ閲覧可能 |
| S003 | XSS対策 | メッセージ内容をサニタイズ、適切にエスケープ |
| S004 | CSRF対策 | WebSocket接続時にトークン検証 |
| S005 | ファイルアップロード制限 | 画像形式・サイズのバリデーション |
| S006 | パストラバーサル対策 | アップロードファイル名のサニタイズ |
| S007 | 個人情報保護 | メッセージは30日で自動削除 |

### ユーザビリティ要件

- **レスポンシブデザイン**: PC、タブレット、スマートフォンで利用可能
- **アクセシビリティ**: WCAG 2.1 AA準拠（キーボード操作、スクリーンリーダー対応）
- **操作性**:
  - Enterキーで送信、Shift+Enterで改行
  - サイドパネルは画面外クリックまたはESCキーで閉じる
  - 画像のドラッグ&ドロップ対応
- **通知**: 新着メッセージはブラウザ通知（権限取得後）
- **エラーメッセージ**: 日本語でわかりやすく表示

### 互換性要件

- **ブラウザ**: Chrome（最新版）、Firefox（最新版）、Safari（最新版）、Edge（最新版）
- **WebSocket**: ブラウザのWebSocket APIサポート必須
- **デバイス**: PC、タブレット、スマートフォン
- **OS**: Windows 10以上、macOS 10.15以上、iOS 14以上、Android 10以上

### 可用性要件

- **稼働率**: 99%以上（月間ダウンタイム7時間以内）
- **WebSocket切断時**: 自動再接続（最大3回リトライ、指数バックオフ）
- **オフライン対応**: 送信失敗メッセージを最大10件キューイング
- **データバックアップ**: 日次でJSONファイルのバックアップ

---

## 4. データ要件

### データモデル

```typescript
// ChatRoom（チャットルーム）
type ChatRoom = {
  id: string;                    // UUID
  title: string;                 // チャットルームタイトル（1-100文字）
  participants: string[];        // 参加者のユーザーID配列
  equipmentId?: string;          // 関連備品ID（任意）
  createdAt: string;             // 作成日時（ISO 8601）
  updatedAt: string;             // 更新日時（ISO 8601）
};

// Message（メッセージ）
type Message = {
  id: string;                    // UUID
  chatRoomId: string;            // チャットルームID
  senderId: string;              // 送信者ID
  content: string;               // メッセージ内容（0-1000文字）
  attachmentUrl?: string;        // 添付画像URL（任意）
  readBy: string[];              // 既読ユーザーID配列
  createdAt: string;             // 送信日時（ISO 8601）
};

// WebSocketConnection（接続情報）- メモリ管理
type WSConnection = {
  userId: string;
  socketId: string;
  connectedAt: Date;
};
```

### データ整合性ルール

- **ChatRoom**:
  - participants 配列は必ず2人（ユーザーと管理者）
  - equipmentId を指定する場合、該当備品が存在すること
  - title は空文字禁止
- **Message**:
  - content が空で attachmentUrl もない場合はエラー
  - senderId は participants に含まれること
  - readBy には必ず senderId が含まれる（送信時に自動追加）
- **ファイル**:
  - 画像ファイルは対応する Message が削除されたら一緒に削除
  - 30日経過したメッセージと画像は自動削除

### データ保存形式

- **JSONファイル**:
  - `data/chat-rooms.json`: チャットルーム一覧
  - `data/messages.json`: メッセージ一覧
- **画像ファイル**:
  - `public/uploads/chat/{chatRoomId}/{uuid}.{ext}`: フルサイズ
  - `public/uploads/chat/{chatRoomId}/thumb_{uuid}.{ext}`: サムネイル
- **エンコーディング**: UTF-8
- **インデント**: スペース2つ

### データ削除ポリシー

- メッセージは送信から30日後に自動削除（日次バッチ処理）
- メッセージ削除時、関連する画像ファイルも削除
- チャットルームは最終メッセージから30日経過で非表示（削除はしない）

---

## 5. 制約条件とリスク

### 技術的制約

- **Next.js 15 (App Router)** を使用
- **WebSocket**: Next.js API RoutesではWebSocketをネイティブサポートしていないため、カスタムサーバー（Bunサーバー）を使用
- **データストレージ**: JSONファイルでの管理（データベース不使用）
- **ファイルロック**: 同時書込による破損を防ぐロック機構が必要
- **スケーラビリティ**: 50ユーザーまでを想定（それ以上はアーキテクチャの見直しが必要）

### ビジネス上の制約

- **開発期間**: 3週間以内
- **予算**: なし（内製開発）
- **初期リリース時のユーザー数**: 50名程度
- **MVP優先**: 最小限の機能から開始、段階的に拡張

### リスク

| リスク | 影響度 | 発生確率 | 対策 |
|--------|--------|----------|------|
| WebSocket実装の複雑さ | 高 | 中 | 早期にプロトタイプを作成し、技術検証を実施 |
| JSONファイルの同時書込エラー | 高 | 中 | ファイルロック機構の実装、エラー時の自動リトライ |
| 大量メッセージのパフォーマンス劣化 | 中 | 低 | ページネーション・無限スクロールで対応 |
| 30日自動削除の実装漏れ | 中 | 低 | cron または定期実行スクリプトで確実に実行 |
| 画像アップロードのストレージ不足 | 中 | 低 | 5MB制限、30日自動削除で対応 |
| ブラウザのWebSocket非対応 | 低 | 低 | 対応ブラウザを明記、非対応時はエラーメッセージ表示 |

---

## 6. スケジュールと優先順位

### Phase 1: MVP（最小限の機能）- Week 1-2

**Must have**
- [ ] WebSocketサーバーのセットアップ（Bunカスタムサーバー）
- [ ] チャットルームのデータモデル作成（chat-rooms.json, messages.json）
- [ ] チャット一覧表示（F001）
- [ ] チャットルーム作成（F002）
- [ ] メッセージ送受信（リアルタイム）（F003, F004）
- [ ] チャットUI（サイドパネル）（F007）
- [ ] 備品詳細ページからのチャット開始（F008）
- [ ] ヘッダーのチャットアイコン（F009）
- [ ] チャット履歴表示（初回50件）（F010）

### Phase 2: 機能拡張 - Week 3

**Should have**
- [ ] 画像添付機能（F005）
- [ ] 未読管理と未読バッジ表示（F006）
- [ ] 管理者のチャット一覧管理画面（F011）
- [ ] 新着通知（ブラウザ通知）（F012）
- [ ] メッセージの無限スクロール（ページネーション）
- [ ] 30日自動削除のバッチ処理

### Phase 3: 品質向上 - Week 3後半

**Could have**
- [ ] オフライン対応（送信キュー機能）
- [ ] 画像のドラッグ&ドロップ対応
- [ ] キーボードショートカット（Enterで送信、ESCで閉じる）
- [ ] アクセシビリティ改善（キーボード操作、ARIA属性）
- [ ] エラー処理の改善（再試行ボタン、詳細なエラーメッセージ）
- [ ] パフォーマンス最適化（メッセージの仮想スクロール）

### 将来対応（Won't have this time）

- グループチャット（3人以上）
- ユーザー同士のダイレクトメッセージ
- メッセージの編集・削除機能
- リアクション機能（いいね、絵文字）
- メンション機能（@username）
- 音声・動画通話
- チャットボット統合
- メールへの通知転送
- 既読メンバーの表示（複数人の場合）
- メッセージの検索機能

---

## 7. 成功指標（KPI）

### 開発完了の定義（Definition of Done）

- [ ] すべてのMust have機能が実装済み
- [ ] WebSocketの接続・切断・再接続が正常動作
- [ ] ユニットテストカバレッジ 70%以上（特にWebSocketロジック）
- [ ] E2Eテストで主要フロー（メッセージ送受信、画像添付）が正常動作
- [ ] コードレビュー完了
- [ ] ユーザー受入テスト完了（管理者+一般ユーザー各2名）
- [ ] ドキュメント作成完了（README、API仕様書）
- [ ] パフォーマンステスト実施（50ユーザー同時接続）

### リリース後の成功指標

- **利用率**: 週1回以上の利用が 70%以上のユーザー
- **応答時間**: 管理者が24時間以内に返信 90%以上
- **ユーザー満足度**: 5段階評価で平均4以上
- **エラー発生率**: メッセージ送信失敗率 1%未満
- **WebSocket稼働率**: 99%以上（切断・再接続を含む）
- **問い合わせ対応時間**: 平均50%短縮（導入前と比較）

---

## 8. 画面フロー・画面遷移図

### 画面フロー

```
[ホーム] または [備品一覧] または [備品詳細]
  │
  ├─ [ヘッダーのチャットアイコン] クリック
  │   → サイドパネル開く → [チャット一覧]
  │       │
  │       ├─ [新規チャット] → [チャット画面]（一般的な問い合わせ）
  │       └─ 既存チャット選択 → [チャット画面]
  │
  └─ [備品詳細ページ] → [問い合わせボタン] クリック
      → サイドパネル開く → [チャット画面]（該当備品に関するチャット）
```

### 管理者の画面フロー

```
[管理者ダッシュボード]
  │
  └─ [ヘッダーのチャットアイコン（未読バッジ付き）] クリック
      → サイドパネル開く → [全チャット一覧]
          │
          └─ チャット選択 → [チャット画面]
              └─ メッセージ送受信
```

### 画面構成

1. **チャット一覧（サイドパネル）**
   - 全チャットルームのリスト
   - 未読バッジ、最終メッセージ、タイムスタンプ
   - 新規チャットボタン

2. **チャット画面（サイドパネル）**
   - ヘッダー: チャットタイトル、戻るボタン
   - メッセージエリア: 過去のメッセージ一覧
   - 入力エリア: メッセージ入力欄、添付ボタン、送信ボタン

3. **画像拡大モーダル**
   - フルサイズ画像表示
   - 閉じるボタン

---

## 9. 技術仕様（概要）

### WebSocketサーバー

**実装方針**
- Bunのカスタムサーバーを使用（`server.ts`）
- `ws` ライブラリでWebSocket実装
- Next.js App Routerと併用（HTTPリクエストはNext.js、WebSocketはBunサーバー）

**接続フロー**
```typescript
// クライアント接続
1. クライアントが ws://localhost:3001/ws に接続
2. サーバーが認証トークンを検証（ログイン済みか確認）
3. 接続成功 → userId と socketId を紐付け（メモリ管理）
4. クライアントが参加中のチャットルームに自動join

// メッセージ送信
1. クライアントが 'message:send' イベントを送信
2. サーバーがメッセージをバリデーション
3. messages.json に保存
4. 該当チャットルームの全参加者にブロードキャスト

// 既読通知
1. クライアントがチャットルームを開く
2. 'message:mark_as_read' イベントを送信
3. サーバーが該当メッセージの readBy 配列を更新
4. 相手にリアルタイムで既読通知
```

### API Routes（REST API）

| エンドポイント | メソッド | 説明 |
|----------------|----------|------|
| `/api/chat/rooms` | GET | チャットルーム一覧取得 |
| `/api/chat/rooms` | POST | 新規チャットルーム作成 |
| `/api/chat/rooms/[id]` | GET | チャットルーム詳細取得 |
| `/api/chat/messages` | GET | メッセージ一覧取得（ページネーション） |
| `/api/chat/upload` | POST | 画像アップロード |

### ディレクトリ構成（追加分）

```
app/
├── api/
│   └── chat/
│       ├── rooms/
│       │   ├── route.ts         # チャットルーム一覧・作成
│       │   └── [id]/
│       │       └── route.ts     # チャットルーム詳細
│       ├── messages/
│       │   └── route.ts         # メッセージ一覧取得
│       └── upload/
│           └── route.ts         # 画像アップロード
├── chat/
│   └── page.tsx                 # チャット専用ページ（任意）
components/
├── chat/
│   ├── ChatSidebar.tsx          # チャットサイドパネル
│   ├── ChatRoomList.tsx         # チャットルーム一覧
│   ├── ChatRoom.tsx             # チャット画面
│   ├── MessageList.tsx          # メッセージ一覧
│   ├── MessageInput.tsx         # メッセージ入力欄
│   └── ImageUpload.tsx          # 画像添付
hooks/
├── useWebSocket.ts              # WebSocket接続管理
├── useChatRooms.ts              # チャットルーム取得
└── useMessages.ts               # メッセージ取得
lib/
├── websocket/
│   ├── server.ts                # WebSocketサーバー（Bun）
│   └── client.ts                # WebSocketクライアント
├── services/
│   ├── chat-service.ts          # チャット関連のビジネスロジック
│   └── message-service.ts       # メッセージ関連のビジネスロジック
└── validations/
    └── chat-schema.ts           # チャット関連のバリデーション
data/
├── chat-rooms.json              # チャットルーム保存
└── messages.json                # メッセージ保存
public/
└── uploads/
    └── chat/                    # チャット画像保存
```

---

## 10. テスト要件

### ユニットテスト

**対象**
- `lib/services/chat-service.ts`: チャットルーム作成、取得
- `lib/services/message-service.ts`: メッセージ送信、既読処理
- `lib/validations/chat-schema.ts`: バリデーションロジック
- `hooks/useWebSocket.ts`: WebSocket接続・切断・再接続ロジック

**テストケース例**
```typescript
describe('chat-service', () => {
  describe('createChatRoom', () => {
    it('新しいチャットルームを作成できる', () => {})
    it('同じ備品に関する既存チャットがある場合、新規作成しない', () => {})
    it('equipmentIdが存在しない場合、エラーを返す', () => {})
  })
})
```

### 統合テスト

**対象**
- API Routes とサービス層の連携
- WebSocketサーバーとクライアントの連携
- ファイルアップロードとストレージの連携

**テストケース例**
```typescript
describe('POST /api/chat/rooms', () => {
  it('正常なリクエストで201を返す', async () => {})
  it('equipmentIdが無効な場合400を返す', async () => {})
  it('未ログインの場合401を返す', async () => {})
})
```

### E2Eテスト（Playwright）

**シナリオ**
1. **メッセージ送受信フロー**
   - ユーザーAがログイン
   - 備品詳細ページから問い合わせを開始
   - メッセージ「起動しません」を送信
   - 管理者Bがログイン（別ブラウザ）
   - チャット一覧に未読バッジが表示される
   - チャットを開いてメッセージを確認
   - 返信「確認します」を送信
   - ユーザーAの画面にリアルタイムで返信が表示される

2. **画像添付フロー**
   - チャットを開く
   - 添付ボタンをクリック
   - 画像ファイル（2MB PNG）を選択
   - プレビューが表示される
   - メッセージと一緒に送信
   - 相手の画面に画像が表示される
   - 画像をクリックして拡大表示

3. **未読管理フロー**
   - ユーザーAが3件のメッセージを送信
   - 管理者Bのヘッダーに未読バッジ「(3)」が表示される
   - チャット一覧を開くと未読バッジが表示される
   - チャットを開くと既読化され、未読バッジが消える

---

## 11. 補足資料

### 用語集

| 用語 | 定義 |
|------|------|
| チャットルーム | ユーザーと管理者が会話を行う空間。1対1のみ対応 |
| メッセージ | チャットルーム内で送受信されるテキストまたは画像 |
| 未読 | 受信者がまだ閲覧していないメッセージの状態 |
| 既読 | 受信者が閲覧したメッセージの状態 |
| サイドパネル | 画面右側からスライドして表示されるUI要素 |
| WebSocket | リアルタイム双方向通信を実現するプロトコル |
| ブロードキャスト | サーバーから複数のクライアントへ同時にメッセージを送信すること |

### 参考リンク

- [WebSocket API (MDN)](https://developer.mozilla.org/ja/docs/Web/API/WebSocket)
- [Next.js App Router](https://nextjs.org/docs/app)
- [Bun Documentation](https://bun.sh/docs)
- [shadcn/ui Components](https://ui.shadcn.com/)
- [TanStack Query](https://tanstack.com/query/latest)
- [Valibot](https://valibot.dev/)

---

**作成日**: 2024-01-15
**最終更新**: 2024-01-15
**バージョン**: 1.0
**作成者**: Claude (Requirements Analyst Agent)
